name: Release

on:
  pull_request:
    branches: 
      - main
    types:
      - opened
      - edited
      - closed
      - reopened
      - synchronize

jobs:
  release:
    if: github.repository == 'watermarkhu/zed-matlab'
    name: Semantic version release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Calculate version
        id: semVersie
        uses: RonaldPhilipsen/semVersie@be135e123ea20206e152e00c85c6cd404f8e2d60 # v2.0.0
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          build-metadata: ${{ github.sha }}

      - name: Update version in Cargo.toml
        if: steps.semVersie.outputs.release == 'true'
        run: |
          sed -i 's/^version = .*/version = "${{ steps.semVersie.outputs.version }}"/' Cargo.toml

      - name: Update version in extension.toml
        if: steps.semVersie.outputs.release == 'true'
        run: |
          sed -i 's/^version = .*/version = "${{ steps.semVersie.outputs.version }}"/' extension.toml

      - name: Create version update commit
        if: steps.semVersie.outputs.release == 'true' && github.event.pull_request.merged == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Cargo.toml extension.toml
          git commit -m "chore: bump version to ${{ steps.semVersie.outputs.version }}"
          git push

      - name: Release
        if: steps.semVersie.outputs.release == 'true' && github.event.pull_request.merged == 'true'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: ${{ steps.semVersie.outputs.tag }}
          body_path: ${{ steps.semVersie.outputs.release-notes-file }}
